{{- if .Values.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "dsx-connect-api.fullname" . }}
  labels:
    {{- include "dsx-connect-api.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "dsx-connect-api.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "dsx-connect-api.selectorLabels" . | nindent 8 }}
    spec:
      {{- if or .Values.tls.enabled .Values.dataVolume.enabled }}
      volumes:
        {{- if .Values.tls.enabled }}
        - name: tls-certs
          secret:
            secretName: {{ .Values.tls.secretName }}
        {{- end }}
        {{- if .Values.dataVolume.enabled }}
        - name: app-data
          {{- if .Values.dataVolume.existingClaim }}
          persistentVolumeClaim:
            claimName: {{ .Values.dataVolume.existingClaim | quote }}
          {{- else if .Values.dataVolume.hostPath }}
          hostPath:
            path: {{ .Values.dataVolume.hostPath | quote }}
          {{- else }}
          emptyDir: {}
          {{- end }}
        {{- end }}
      {{- end }}
      containers:
        - name: dsx-connect-api
          image: "{{ default .Values.image.repository $.Values.global.image.repository }}:{{ coalesce .Values.image.tag $.Values.global.image.tag .Chart.AppVersion }}"
          imagePullPolicy: {{ default .Values.image.pullPolicy $.Values.global.image.pullPolicy }}
          command: ["uvicorn"]
          args: [
            "dsx_connect.app.dsx_connect_api:app",
            "--host", "0.0.0.0",
            "--port", "{{ .Values.service.port }}"
            {{- if .Values.tls.enabled }},
            "--ssl-keyfile", "{{ .Values.tls.mountPath }}/tls.key",
            "--ssl-certfile", "{{ .Values.tls.mountPath }}/tls.crt"
            {{- end }}
          ]
          ports:
            - containerPort: {{ .Values.service.port }}
              name: http
            {{- if .Values.tls.enabled }}
            - containerPort: {{ .Values.tls.port }}
              name: https
            {{- end }}
          env:
            {{ $env := merge (default (dict) $.Values.global.env) (default (dict) .Values.env) }}
            {{ $scanner := default (dict) $.Values.global.scanner }}
            {{ $svc := default (printf "%s-dsxa-scanner" $.Release.Name) $scanner.serviceName }}
            {{ $port := default 5000 $scanner.port }}
            {{ $scheme := default "http" $scanner.scheme }}
            - name: DSXCONNECT_APP_ENV
              value: {{ $env.DSXCONNECT_APP_ENV | default "dev" | quote }}
            - name: DSXCONNECTOR_API_KEY
              value: {{ $env.DSXCONNECTOR_API_KEY | default "api-key-NOT-FOR-PRODUCTION" | quote }}
            - name: DSXCONNECT_SCANNER__SCAN_BINARY_URL
              value: {{ $env.DSXCONNECT_SCANNER__SCAN_BINARY_URL | default (printf "%s://%s:%d/scan/binary/v2" $scheme $svc $port) | quote }}
            - name: DSXCONNECT_WORKERS__BROKER
              value: {{ $env.DSXCONNECT_WORKERS__BROKER | default "redis://redis:6379/5" | quote }}
            - name: DSXCONNECT_WORKERS__BACKEND
              value: {{ $env.DSXCONNECT_WORKERS__BACKEND | default "redis://redis:6379/6" | quote }}
            - name: DSXCONNECT_REDIS_URL
              value: {{ $env.DSXCONNECT_REDIS_URL | default "redis://redis:6379/3" | quote }}
            - name: DSXCONNECT_RESULTS_DB
              value: {{ $env.DSXCONNECT_RESULTS_DB | default "redis://redis:6379/3" | quote }}
            - name: DSXCONNECT_RESULTS_DB__RETAIN
              value: {{ $env.DSXCONNECT_RESULTS_DB__RETAIN | default "100" | quote }}
            - name: PYTHONUNBUFFERED
              value: {{ $env.PYTHONUNBUFFERED | default "1" | quote }}
            - name: LOG_LEVEL
              value: {{ $env.LOG_LEVEL | default "debug" | quote }}
            {{- with $env }}
            {{- range $key, $value := . }}
            {{- if not (has $key (list "DSXCONNECT_APP_ENV" "DSXCONNECTOR_API_KEY" "DSXCONNECT_SCANNER__SCAN_BINARY_URL" "DSXCONNECT_WORKERS__BROKER" "DSXCONNECT_WORKERS__BACKEND" "DSXCONNECT_REDIS_URL" "DSXCONNECT_RESULTS_DB" "DSXCONNECT_DATABASE__LOC" "DSXCONNECT_DATABASE__RETAIN" "DSXCONNECT_RESULTS_DB__RETAIN" "PYTHONUNBUFFERED" "LOG_LEVEL")) }}
            - name: {{ $key }}
              value: "{{ $value }}"
            {{- end }}
            {{- end }}
            {{- end }}
          {{- if or .Values.tls.enabled .Values.dataVolume.enabled }}
          volumeMounts:
            {{- if .Values.tls.enabled }}
            - name: tls-certs
              mountPath: {{ .Values.tls.mountPath | quote }}
              readOnly: true
            {{- end }}
            {{- if .Values.dataVolume.enabled }}
            - name: app-data
              mountPath: "/app/data"
              readOnly: false
            {{- end }}
          {{- end }}
          livenessProbe:
            httpGet:
              path: /dsx-connect/api/v1/healthz
              port: {{ .Values.service.port }}
              scheme: {{ if .Values.tls.enabled }}HTTPS{{ else }}HTTP{{ end }}
            initialDelaySeconds: 40
            periodSeconds: 30
            timeoutSeconds: 10
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /dsx-connect/api/v1/readyz
              port: {{ .Values.service.port }}
              scheme: {{ if .Values.tls.enabled }}HTTPS{{ else }}HTTP{{ end }}
            initialDelaySeconds: 40
            periodSeconds: 30
            timeoutSeconds: 10
            successThreshold: 1
            failureThreshold: 3
      terminationGracePeriodSeconds: 30
{{- end }}
